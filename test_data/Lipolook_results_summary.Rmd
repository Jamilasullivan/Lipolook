---
title: "Lipolook Results Summary"
author: "Jamila Sullivan-Al-Kadhomiy"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
source("C:/Users/jamsu/OneDrive - Cardiff University/University/Masters/Big Data Biology/Modules/Dissertation/R Programme/Dissertation/Lipolook_planning_bare_script.R")
```

This run of the Lipolook pipeline has used you inputs and analysed your lipidomics data successfully.

## Variables

The adjustment method chosen and used for all statistical tests was:

```{r}
adjustment_method
```

The name stated of your grouping column was:

```{r}
groups
```

The name stated for you control group was: 

```{r}
control_group
```

## Potnetial Errors

The columns in your raw data with values found to be identical to at least one other were named:

```{r}
duplicated_column_names
```

These may be mistakes in the data or may be intentional but should be checked before interpreting the following results.

The columns in your data that were unable to be matched to a lipid family were:

```{r}
unmatched_cols
```

The data from columns shown here will not be included in further analysis as they have been unable to be assigned a lipid family. If you would like them included in further analysis, please revert to the input data, alter the column names accordingly and run the pipeline again.

Mismatched columns of incorrectly named lipids may also be included in the metadat file. Therefore, it is important that these column names are checked and confirmed to be metadata only: 

```{r}
names(metadata)
```

Again, if any data has been wrongly stored here, please revert to the original data to fix the issue and run the pipeline again. 

Further information on how the inputs to the pipeline should be formatted to ensure proper function can be found in the *Lipolook_instructions.html* file. 

## Forest Plots

While forest plots have also been created for the lipids within each family, below shows a forest plot summary (with absolute difference values) for each lipid category: 

```{r forest-plots, echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, fig.height=12}
library(patchwork)

top_level_dir <- file.path("outputs", "lipid_categories")
counter <- 1
total_categories <- length(category_dfs)

plots_list <- list() 

for (category in names(category_dfs)) {
  message("Processing category ", counter, " of ", total_categories, ": ", category)
  
  df_category <- category_dfs[[category]]
  df_category$total <- as.numeric(df_category$total)
  
  summary_df <- df_category %>%
    group_by(group) %>%
    summarize(
      mean_total = mean(total, na.rm = TRUE),
      sd_total   = sd(total, na.rm = TRUE),
      n          = n(),
      se_total   = sd_total / sqrt(n),
      .groups    = "drop"
    )
  
  if (!control_group %in% summary_df$group) {
    message("Control group not found for category ", category, " — skipping plot")
    counter <- counter + 1
    next
  }
  
  control_mean <- summary_df$mean_total[summary_df$group == control_group]
  summary_df <- summary_df %>%
    mutate(diff_from_control = mean_total - control_mean)
  
  plot_df <- summary_df %>% filter(group != control_group)
  
  if (nrow(plot_df) == 0) {
    message("No groups to plot for category ", category, " — skipping plot")
    counter <- counter + 1
    next
  }
  
  max_diff <- max(
    abs(plot_df$diff_from_control + plot_df$se_total), 
    abs(plot_df$diff_from_control - plot_df$se_total), 
    na.rm = TRUE
  )
  
  plot <- ggplot(plot_df, aes(y = group, x = diff_from_control)) +
    geom_point(size = 3, color = "#990101") +
    geom_errorbarh(aes(
      xmin = diff_from_control - se_total,
      xmax = diff_from_control + se_total
    ), height = 0.1, color = "#990101") +
    geom_vline(xintercept = 0, linetype = "dashed", color = "#747373") +
    labs(
      title = paste("Forest plot (relative to Control):", category),
      x = "Difference from Control (sum of lipids)",
      y = "Group"
    ) +
    theme_bw() +
    coord_cartesian(xlim = c(-max_diff, max_diff))
  
  plots_list[[category]] <- plot
  
  folder_path <- file.path(top_level_dir, category)
  if (!dir.exists(folder_path)) dir.create(folder_path, recursive = TRUE)
  
  ggsave(
    filename = file.path(folder_path, paste0(category, "_absolute_change_forest_plot.png")),
    plot = plot,
    width = 6,
    height = 8
  )
  
  message("Saved forest plot for category: ", category)
  counter <- counter + 1
}

if (length(plots_list) > 0) {
  combined <- wrap_plots(plots_list, ncol = 2)
  print(combined)
}
```

Furthermore, the same category summary forest plots with log2 transformed x-axis scales:

```{r log2-forest-plots, echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, fig.height=12}
library(ggplot2)
library(dplyr)
library(patchwork)  

all_plots <- list()

counter <- 1
total_categories <- length(category_dfs)

for (category in names(category_dfs)) {
  message("Processing category ", counter, " of ", total_categories, ": ", category)
  
  df_category <- category_dfs[[category]]
  df_category$total <- as.numeric(df_category$total)
  
  summary_df <- df_category %>%
    group_by(group) %>%
    summarize(
      mean_total = mean(total, na.rm = TRUE),
      sd_total = sd(total, na.rm = TRUE),
      n = n(),
      se_total = sd_total / sqrt(n),
      .groups = "drop"
    )
  
  if (!control_group %in% summary_df$group) {
    message("Control group not found for category ", category, " — skipping plot")
    counter <- counter + 1
    next
  }
  
  control_mean <- summary_df$mean_total[summary_df$group == control_group]
  summary_df <- summary_df %>%
    mutate(
      fold_change = mean_total / control_mean,
      log2_fold_change = log2(fold_change)
    )
  
  plot_df <- summary_df %>% filter(group != control_group)
  
  if (nrow(plot_df) == 0) {
    message("No groups to plot for category ", category, " — skipping plot")
    counter <- counter + 1
    next
  }
  
  max_abs_log2 <- max(
    abs(plot_df$log2_fold_change + (plot_df$se_total / (control_mean * log(2)))),
    abs(plot_df$log2_fold_change - (plot_df$se_total / (control_mean * log(2)))),
    na.rm = TRUE
  )
  
  plot <- ggplot(plot_df, aes(y = group, x = log2_fold_change)) +
    geom_point(size = 3, color = "#990101") +
    geom_errorbarh(aes(
      xmin = log2_fold_change - (se_total / (control_mean * log(2))),
      xmax = log2_fold_change + (se_total / (control_mean * log(2)))
    ), height = 0.1, color = "#990101") +
    geom_vline(xintercept = 0, linetype = "dashed", color = "#747373") +
    labs(
      title = paste("Category-level Forest Plot:", category),
      x = "Log2 Fold Change from Control",
      y = "Group"
    ) +
    theme_bw() +
    coord_cartesian(xlim = c(-max_abs_log2, max_abs_log2))
  
  all_plots[[category]] <- plot
  counter <- counter + 1
}

plot_list <- all_plots
n <- length(plot_list)

combined_plot <- wrap_plots(plot_list, ncol = 2, byrow = TRUE)

combined_plot + plot_layout(guides = "collect")

```
































