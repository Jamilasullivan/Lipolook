---
title: "Lipolook 0.1.0"
author: "Jamila Sullivan-Al-Kadhomiy"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "C:/Users/jamsu/OneDrive - Cardiff University/University/Masters/Big Data Biology/Modules/Dissertation/R Programme/Dissertation/test_data")
```

# Introduction

Lipolook 0.1.0 is a currently a basic pipeline for exploration of lipidomics data. It is able to provide statistical outputs and visualisations recommended by those working in the field. 

It does this using simple inputs and organises the outputs into a logical directory system, within your local files. 

It requires minimal inputs or alterations to run. However, further versions of this pipeline plan to further refine this feature. 

Here, we will look at how the pipeline runs in an explanitory fashion and provide users with assistance on their inputs to the pipeline. We will look at each section of the *Lipolook_planning_bare_script.R*  file, in accordance with its numbered sections. This will provide a detailed explaination of how the script works and make it more managable for those less familiar with reading R Studio code.

THe *Lipolook_planning_annotated.R* script also provides a script with included descriptions of individual coding tasks, for those more comfortable with reading R Studio code or interesting the tasks completed by each section.

For any further queries, errors or if anything is unclear, please contact: sullivan-al-kadhomiyj@cardiff.ac.uk

All information related to this pipeline can be found at: https://github.com/Jamilasullivan/Lipolook

\

# Instructions

## **Variables**

### 1. Variables For The User To Complete 

This section provides the user with optional preferences that will then be used in later Lipolook code. These fields should be completed manually before running the code. This process should be quick and simple.

\

#### Working Directory

```{r}
working_directory <- "test_data"
```

In this case `"test_data"` refers to the directory in which your raw data is held. For clear organisation, aim to have this directory free of anything else. If you are unsure on this path, navigate to the files tab in R Studio, access the file in which your data is stored, click the 'more' drop down menu at the top of the files pane and select 'Copy Folder Path to Clipboard'. You should then be able to past this directly into the script between the speech marks.

\

#### Raw Data

```{r}
raw_data_file_name <- "raw_data_1.csv"
```

Here, `"raw_data_1.csv"` refers to the raw lipid data that the pipeline requires to run. This will be provided to you. The name of the file should be given exactly as it is named on your PC. Any spaces or special characters should be replaced with '_' before completing this step. Furthermore, this excel sheet should be saved as a .csv file and this suffix added to the "file_name". An example of how this file should be laid out is given below. The essential part is that all metadata should be given before the start of the lipid data and one metadata column must include groupings. The lipids in this file should include all the lipid results combined. The sample numbers (not IDs) should be equivalent to the row numbers, to make results traceable. 

| Sample | Metadata 1 | Metadata 2 | Metadata 3 | Metadata *n* | Lipid 1 | Lipid 2 | Lipid 3 | Lipid *n* |
|:-------|:-----------|:-----------|:-----------|:-------------|:--------|:--------|:--------|:----------|
| S1     | A          | X          | 12         | ...          | data    | data    | data    | ...       |
| S2     | B          | Y          | 15         | ...          | data    | data    | data    | ...       |
| S3     | C          | Z          | 18         | ...          | data    | data    | data    | ...       |
| S4     | D          | W          | 20         | ...          | data    | data    | data    | ...       |
| S5     | E          | V          | 22         | ...          | data    | data    | data    | ...       |

\

#### Lipids Tested

```{r}
lipids_tested_file_name <- "lipids_tested_1.csv"
```

Here, `"lipids_tested_1.csv"` refers to the document containing details of which lipids were tested when running the LC-MS method. This will be provided to you as the second sheet of the raw data sreadsheet. You should save this second sheet as a separate .csv file. The name of the file should be given exactly as it is named on your PC. Any spaces or special characters should be replaced with '_' before completing this step. Furthermore, this excel sheet should be saved as a .csv file and this suffix added to the "file_name". An example of how this file should be laid out is given below. The important part is that lipid family names should be the head of columns and all lipids included in that family should be given in rows below it. 

| Family A  | Family B  | Family C  | Family *n*  |
|:----------|:----------|:----------|:------------|
| Lipid A1  | Lipid B1  | Lipid C1  | Lipid *n*1  |
| Lipid A2  | Lipid B2  | Lipid C2  | Lipid *n*2  |
| Lipid A3  | Lipid B3  | Lipid C3  |             |
| Lipid A4  | Lipid B4  |           |             |
|           | Lipid B5  |           |             |

\

#### Adjustment Method

```{r}
adjustment_method <- "fdr" # options are "holm" = Holm–Bonferroni
                           #             "hochber" = Hochberg
                           #             "hommel" = Hommel
                           #             "bonferroni" = Bonferroni
                           #             "BH" or "fdr" = Benjamini–Hochberg
                           #             "BY" = Benjamini–Yekutieli
                           #             "none" = No adjustment
```

Here, `"fdr"` refers to which adjustment method you would like to use to account for multiple testing for correction. As can be seen above, the options available are given in the code. The method chosen, will be used throughout all subsequent code unless the subsequent code is adjusted.

\

## **Data Organisation**

### 2. Packages to install

```{r, results='hide', message=FALSE, warning=FALSE}
packages <- c("moments", "tidyr", "dplyr", "ggplot2", "stats")

for (pkg in packages) {
  if (!requireNamespace(pkg, quietly = TRUE)) {
    install.packages(pkg)
  }
}

lapply(packages, library, character.only = TRUE)

library(moments)
library(tidyr)
library(dplyr)
library(ggplot2)
library(stats)
```

This block of code will conditionally install (if not already present) and load all packages required for the pipeline. Version control of these packages can be found in the linked GitHub repository.

### 3. Setting Work Directory

`setwd(working_directory)` is included in the original script but cannot function in an R Markdown file. It sets the working directory as the initial `working_directory` path set.

### 4. Creating Directory Structure

```{r, results='hide', message=FALSE, warning=FALSE}
if(!dir.exists("outputs")){
  cat("'Outputs' directory created")
  dir.create("outputs")
} else {
  cat("'Outputs' directory already exists")
}

if(!dir.exists("outputs/total_lipids")){
  cat("'total_lipids' directory created")
  dir.create("outputs/total_lipids", recursive = TRUE)
} else {
  cat("'total_lipids' directory already exists")
}

if(!dir.exists("outputs/error_files")){
  cat("'error_files' directory created")
  dir.create("outputs/error_files", recursive = TRUE)
} else {
  cat("'error_files' directory already exists")
}
```


### 5. Initial Data Tidying

```{r, results='hide', message=FALSE, warning=FALSE}
raw_data <- read.csv(raw_data_file_name, header = T)
names(raw_data)[c(1,2,3,4,5)] <- c("Filename", "CMaLL Sample Name", "Group", "code", "Cell Count")
raw_data <- raw_data[-1,]
raw_data$code <- NULL
raw_data$`Cell Count` <- NULL
str(raw_data)
raw_data[, 4:ncol(raw_data)] <- lapply(raw_data[, 4:ncol(raw_data)], function(x)
  as.numeric(as.character(x)))
sum(is.na(raw_data[, 4:ncol(raw_data)]))
str(raw_data)
sapply(raw_data, is.numeric)
```


### 6. Raw Data Manipulation

```{r}
raw_data_lipids <- raw_data
rownames(raw_data_lipids) <- raw_data_lipids[[2]]
raw_data_lipids <- raw_data_lipids[, -(1:2)]
duplicated_columns <- duplicated(as.list(raw_data_lipids))
any(duplicated_columns)
duplicated_column_names <- names(raw_data_lipids)[duplicated_columns]
print(duplicated_column_names)
duplicated_column_names <- data.frame(duplicated_columns = duplicated_column_names)
write.csv(duplicated_column_names, "outputs/error_files/duplicated_columns.csv", row.names = FALSE)
```


### 7. Lipids Tested File Manipulation

```{r}

lipids_tested <- read.csv(lipids_tested_file_name, header = T)
lipids_tested <- pivot_longer(lipids_tested,
    cols = everything(),
    names_to = "family",
    values_to = "lipid"
  )
lipids_tested <- lipids_tested[order(lipids_tested$family), ]
lipids_tested <- lipids_tested[!(is.na(lipids_tested$lipid) | lipids_tested$lipid == ""), ]
lipids_tested$lipid <- make.names(lipids_tested$lipid)
```


### 8. Checking For Mismatched Columns

```{r}
raw_data_columns <- colnames(raw_data_lipids[2:ncol(raw_data_lipids)])
lipids <- lipids_tested$lipid
unmatched_cols <- setdiff(raw_data_columns, lipids)
number_unmatched <- length(unmatched_cols)
unmatched_cols <- data.frame(Unmatched_columns = unmatched_cols)
write.csv(unmatched_cols, "outputs/error_files/unmatched_columns.csv", row.names = FALSE)
```


### 9. Subset Data By Lipid Family

```{r, results='hide', message=FALSE, warning=FALSE}
sanitize_name <- function(x) {
  x <- gsub("[^A-Za-z0-9]+", "_", x)  # replace non-alphanumeric with underscore
  x <- gsub("_+", "_", x)             # collapse multiple underscores
  x <- gsub("^_|_$", "", x)           # trim leading/trailing underscores
  x
}

lipids_tested$Family_clean <- sanitize_name(lipids_tested$family)
lipid_families <- split(lipids_tested$lipid, lipids_tested$Family_clean)
raw_data_by_family <- list()

for(family in names(lipid_families)) {
  cols <- lipid_families[[family]]
  cols <- intersect(cols, colnames(raw_data_lipids))
  raw_data_by_family[[family]] <- raw_data[, cols, drop = FALSE]
}

for(family in names(raw_data_by_family)) {
  assign(paste0("raw_data_", family), raw_data_by_family[[family]])
}

all_raw_data <- ls(pattern = "^raw_data_")

for (name in all_raw_data) {
  df <- get(name)
  if (is.data.frame(df) && ncol(df) == 0) {
    message("Removing empty data frame: ", name)
    rm(list = name, envir = .GlobalEnv)
    all_raw_data <- setdiff(all_raw_data, name)  
  }
}

raw_data_names <- Filter(function(x) {
  obj <- get(x)
  
  if (!is.data.frame(obj)) {
    message("Excluded for not being a data frame: ", x)
    return(FALSE)
  }
  
  if (!all(sapply(obj, is.numeric))) {
    message("Excluded for non-numeric columns: ", x)
    return(FALSE)
  }

  TRUE
}, all_raw_data)

raw_data_CPEs <- raw_data_Ceramide_phospho_ethanolamines
rm(raw_data_Ceramide_phospho_ethanolamines)
raw_data_Chol_CEs <- raw_data_Cholesterol_cholesteryl_esters
rm(raw_data_Cholesterol_cholesteryl_esters)
raw_data_LPEs <- raw_data_Lysophosphatidy_ethanolamines
rm(raw_data_Lysophosphatidy_ethanolamines)

raw_data_names <- c(raw_data_names, c("raw_data_CPEs", "raw_data_Chol_CEs", "raw_data_LPEs"))
raw_data_names <- raw_data_names[!raw_data_names %in% c("raw_data_Ceramide_phospho_ethanolamines", "raw_data_Cholesterol_cholesteryl_esters", "raw_data_Lysophosphatidy_ethanolamines")]

raw_data_names
```


### 10. Creating directories For All Lipid Families and Categories

```{r}
category_mapping <- read.csv("lipid_categories_1.csv", stringsAsFactors = FALSE)

category_mapping$Family_clean   <- sanitize_name(category_mapping$Family)
category_mapping$Category_clean <- sanitize_name(category_mapping$Category)

top_level_dir <- file.path("outputs", "lipid_categories")

if (!dir.exists(top_level_dir)) {
  dir.create(top_level_dir, recursive = TRUE, showWarnings = FALSE)
}

count <- 1

for (name in raw_data_names) {
  lipid_family <- make.names(sub("^raw_data_", "", name))
  category <- category_mapping$Category_clean[category_mapping$Family_clean == lipid_family][1]
  
  if (is.na(category) || length(category) == 0) {
    message("No category found for family: ", lipid_family)
    next
  }
  
  folder_path <- file.path(top_level_dir, category, lipid_family)
  
  if (!dir.exists(folder_path)) {
    dir.create(folder_path, recursive = TRUE, showWarnings = FALSE)
    message(count, ". Folder created: ", folder_path)
    count <- count + 1
  }
}
```

 
## **Basic Descriptive Statistics**

### 11. Adding Groups Back To Data Frames

```{r, results='hide', message=FALSE, warning=FALSE}
groups <- raw_data[,3]

for (name in raw_data_names) {
  cat("Adding 'groups' column to:", name, "\n")
  df <- get(name)
  df <- cbind(groups, df)
  assign(name, df)
} 

for (name in raw_data_names) {
  lipid_family <- make.names(sub("^raw_data_", "", name))
  category <- category_mapping$Category_clean[category_mapping$Family_clean == lipid_family][1]
  
  if (is.na(category) || length(category) == 0) {
    message("No category found for family: ", lipid_family)
    next
  }
  
  folder_path <- file.path(top_level_dir, category, lipid_family)
  cat("Saving raw data for:", name, "\n")
  df <- get(name)
  write.csv(df, file = file.path(folder_path, paste0(lipid_family, "_raw_data.csv")), row.names = FALSE)
  
}
```

### 12. Calculating Group Averages

```{r, results='hide', message=FALSE, warning=FALSE}
top_level_dir <- file.path("outputs", "lipid_categories")

for (name in raw_data_names) {
  lipid_family <- make.names(sub("^raw_data_", "", name))
  category <- category_mapping$Category_clean[category_mapping$Family_clean == lipid_family][1]
  
  if (is.na(category) || length(category) == 0) {
    message("No category found for family: ", lipid_family)
    next
  }
  
  folder_path <- file.path(top_level_dir, category, lipid_family)
  cat("Saving averages for:", name, "to folder:", folder_path, "\n")
  df_avg <- aggregate(. ~ groups, data = get(name), FUN = mean)
  csv_file <- file.path(folder_path, paste0(lipid_family, "_avg.csv"))
  write.csv(df_avg, file = csv_file, row.names = FALSE)
}
```

### 13. Histograms For Normality

```{r, results='hide', message=FALSE, warning=FALSE}
top_level_dir <- file.path("outputs", "lipid_categories")

for (name in raw_data_names) {
  lipid_family <- sub("^raw_data_", "", name)
  category <- category_mapping$Category_clean[category_mapping$Family_clean == lipid_family][1]
  
  if (is.na(category) || length(category) == 0) {
    message("No category found for family: ", lipid_family)
    next
  }
  
  folder_path <- file.path(top_level_dir, category, lipid_family)
  
  hist_folder <- file.path(folder_path, "histograms")
  if (!dir.exists(hist_folder)) {
    dir.create(hist_folder, recursive = TRUE, showWarnings = FALSE)
    message("Created histograms subfolder for: ", lipid_family)
  }
  
  cat("Processing histograms for:", name, "\n")
  df <- get(name)
  
  for (col in setdiff(names(df), "groups")) {
    png(file.path(hist_folder, paste0(col, "_hist.png")))
    hist(df[[col]],
         main = paste("Histogram of", col),
         xlab = col,
         breaks = 30)
    dev.off()
  }
}
```

### 14. Normality Outputs For All Samples COmbined

```{r, results='hide', message=FALSE, warning=FALSE}
top_level_dir <- file.path("outputs", "lipid_categories")

for (name in raw_data_names) {
  lipid_family <- sub("^raw_data_", "", name)
  category <- category_mapping$Category_clean[category_mapping$Family_clean == lipid_family][1]
  
  if (is.na(category) || length(category) == 0) {
    message("No category found for family: ", lipid_family)
    next
  }
  
  folder_path <- file.path(top_level_dir, category, lipid_family)  
  df <- get(name)
  lipid_columns <- names(df)[-1]
  distribution_summary <- data.frame(
    lipid = lipid_columns,
    skewness = numeric(length(lipid_columns)),
    kurtosis = numeric(length(lipid_columns)),
    shapiro_p = numeric(length(lipid_columns)),
    normality = character(length(lipid_columns)),
    stringsAsFactors = FALSE
  )
  
  for (i in seq_along(lipid_columns)) {
    lipid <- lipid_columns[i]
    values <- df[[lipid]]  
    distribution_summary$skewness[i] <- skewness(values)
    distribution_summary$kurtosis[i] <- kurtosis(values)
    
    if (length(values) >= 3 & length(values) <= 5000) {
      shapiro_res <- shapiro.test(values)
      distribution_summary$shapiro_p[i] <- shapiro_res$p.value
      distribution_summary$normality[i] <- ifelse(shapiro_res$p.value > 0.05, "Normal", "Non-normal")
    } else {
      distribution_summary$shapiro_p[i] <- NA
      distribution_summary$normality[i] <- "NA"
    }
  }
  
  distribution_summary$shapiro_p_adj <- p.adjust(distribution_summary$shapiro_p, method = adjustment_method)
  distribution_summary$normality <- ifelse(distribution_summary$shapiro_p_adj > 0.05, "Normal", "Non-normal")
  distribution_summary <- distribution_summary[, c("lipid", "skewness", "kurtosis", "shapiro_p", "shapiro_p_adj", "normality")]
  cat("Saving distribution summary for:", name, "\n")
  
  if (!dir.exists(folder_path)) {
    dir.create(folder_path, recursive = TRUE, showWarnings = FALSE)
  }
  
  dis_csv_file <- file.path(folder_path, paste0(lipid_family, "_distribution.csv"))
  write.csv(distribution_summary, file = dis_csv_file, row.names = FALSE)
}

## number of all lipids that reached normality with shapiro-wilk test (plus correction for multiple testing)

top_level_dir <- file.path("outputs", "lipid_categories")
all_distribution_csv_files <- list.files(top_level_dir, pattern = "_distribution\\.csv$", full.names = TRUE, recursive = TRUE)
all_lipids_distribution <- list()

for (file in all_distribution_csv_files) {
  df <- read.csv(file, header = TRUE)
  summary_df <- df[, c(1, ncol(df))]
  summary_df$family <- basename(file)
  all_lipids_distribution[[length(all_lipids_distribution) + 1]] <- summary_df
}

combined_summary <- bind_rows(all_lipids_distribution)
combined_summary <- combined_summary[-3]
write.csv(combined_summary, file = file.path(top_level_dir,"..","total_lipids", "combined_lipid_normality.csv"), row.names = FALSE)
distribution_counts <- table(combined_summary$normality)
distribution_counts_df <- as.data.frame(distribution_counts)
distribution_total <- sum(distribution_counts)
distribution_counts_df$percent <- round(100 * distribution_counts_df$Freq / distribution_total, 1)
distribution_counts_df
write.csv(distribution_counts_df, file = file.path(top_level_dir,"..","total_lipids", "combined_lipid_normality_summary.csv"), row.names = FALSE)
```























