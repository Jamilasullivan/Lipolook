---
title: "Lipolook 0.1.0"
author: "Jamila Sullivan-Al-Kadhomiy"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "C:/Users/jamsu/OneDrive - Cardiff University/University/Masters/Big Data Biology/Modules/Dissertation/R Programme/Dissertation/test_data")
```

# Introduction

Lipolook 0.1.0 is a currently a basic pipeline for exploration of lipidomics data. It is able to provide statistical outputs and visualisations recommended by those working in the field. 

It does this using simple inputs and organises the outputs into a logical directory system, within your local files. 

It requires minimal inputs or alterations to run. However, further versions of this pipeline plan to further refine this feature. 

Here, we will look at how the pipeline runs in an explanitory fashion and provide users with assistance on their inputs to the pipeline. We will look at the data organisation sections of the *Lipolook_planning_bare_script.R*  file, in accordance with its numbered sections. This will provide a detailed explaination of how these sections work and what the requirements are for the pipeline to run correctly. The code following these sections should be autonomous.

THe *Lipolook_planning_annotated.R* script also provides a script with included descriptions of individual coding tasks, for those more comfortable with reading R Studio code or interesting the tasks completed by each section.

Please be aware that everything in R Studio is case and character sensitive. Therefore, when filling in the variables or altering any other sections, please write as such. 

If any issues are encountered and fixed within the script, best practice is to delete all outputs currently made, clear the environment and run the pipeline again from the start. 

For any further queries, errors or if anything is unclear, please contact: sullivan-al-kadhomiyj@cardiff.ac.uk

All information related to this pipeline can be found at: https://github.com/Jamilasullivan/Lipolook

\

# Instructions

## **Variables**

### 1. Variables For The User To Complete 

This section provides the user with optional preferences that will then be used in later Lipolook code. These fields should be completed manually before running the code. This process should be quick and simple.

\

#### Working Directory

```{r}
working_directory <- "test_data"
```

In this case `"test_data"` refers to the directory in which your raw data is held. For clear organisation, aim to have this directory free of anything else. If you are unsure on this path, navigate to the files tab in R Studio, access the file in which your data is stored, click the 'more' drop down menu at the top of the files pane and select 'Copy Folder Path to Clipboard'. You should then be able to paste this directly into the script between the speech marks.

\

#### Raw Data

```{r}
raw_data_file_name <- "raw_data_1.csv"
```

Here, `"raw_data_1.csv"` refers to the raw lipid data that the pipeline requires to run. This will be provided to you. The name of the file should be given exactly as it is named on your PC. Any spaces or special characters should be replaced with '_' before completing this step. Furthermore, this excel sheet should be saved as a .csv file and this suffix added to the "file_name". An example of how this file should be laid out is given below. The essential part is that all metadata should be given before the start of the lipid data and one metadata column must include groupings. The lipids in this file should include all the lipid results combined. The sample numbers (not IDs) should be equivalent to the row numbers, to make results traceable. The lipids named here should be in the format of TG(50:0) for example. This ensures that they are recognised as lipids and not wrongly recognised as metadata. Equally, metadata should not end with any special characters. This is because this pipeline recognises the `)` transformed to `.`. Therefore, any metadata ending in a special character that could be transformed to `.` will result in it being wrongly stored as a lipid and unnoticed by the pipeline. Therefore, it is goo practice to check the variables in the data frames produced by sorting. 

| Sample | Metadata 1 | Metadata 2 | Metadata 3 | Metadata *n* | Lipid 1 | Lipid 2 | Lipid 3 | Lipid *n* |
|:-------|:-----------|:-----------|:-----------|:-------------|:--------|:--------|:--------|:----------|
| S1     | A          | X          | 12         | ...          | data    | data    | data    | ...       |
| S2     | B          | Y          | 15         | ...          | data    | data    | data    | ...       |
| S3     | C          | Z          | 18         | ...          | data    | data    | data    | ...       |
| S4     | D          | W          | 20         | ...          | data    | data    | data    | ...       |
| S5     | E          | V          | 22         | ...          | data    | data    | data    | ...       |

\

#### Lipids Tested

```{r}
lipids_tested_file_name <- "lipids_tested_1.csv"
```

Here, `"lipids_tested_1.csv"` refers to the document containing details of which lipids were tested when running the LC-MS method. This will be provided to you as the second sheet of the raw data spreadsheet. You should save this second sheet as a separate .csv file. The name of the file should be given exactly as it is named on your PC. Any spaces or special characters should be replaced with '_' before completing this step. Furthermore, this excel sheet should be saved as a .csv file and this suffix added to the "file_name". An example of how this file should be laid out is given below. The important part is that lipid family names should be the head of columns and all lipids included in that family should be given in rows below it. 

| Family A  | Family B  | Family C  | Family *n*  |
|:----------|:----------|:----------|:------------|
| Lipid A1  | Lipid B1  | Lipid C1  | Lipid *n*1  |
| Lipid A2  | Lipid B2  | Lipid C2  | Lipid *n*2  |
| Lipid A3  | Lipid B3  | Lipid C3  |             |
| Lipid A4  | Lipid B4  |           |             |
|           | Lipid B5  |           |             |

\

#### Adjustment Method

```{r}
adjustment_method <- "fdr" # options are "holm" = Holm–Bonferroni
                           #             "hochber" = Hochberg
                           #             "hommel" = Hommel
                           #             "bonferroni" = Bonferroni
                           #             "BH" or "fdr" = Benjamini–Hochberg
                           #             "BY" = Benjamini–Yekutieli
                           #             "none" = No adjustment
```

Here, `"fdr"` refers to which adjustment method you would like to use to account for multiple testing for correction. As can be seen above, the options available are given in the code. The method chosen, will be used throughout all subsequent code unless the subsequent code is adjusted.

#### Group

```{r}
groups <- "Group" 
```

`"Group"` refers to the name of the column in your raw data under which groupings are stored. 

#### Control group

```{r}
control_group <- "E"
```

`"E"` refers to the name of the control group within your data.

\

## **Data Organisation**

### 2. Packages to install

```{r, results='hide', message=FALSE, warning=FALSE}
packages <- c(
  "moments", "tidyr", "dplyr", "ggplot2", "stats", "pheatmap",
  "ggrepel","readr", "tidyverse", "FSA"
)

for (pkg in packages) {
  if (!requireNamespace(pkg, quietly = TRUE)) {
    install.packages(pkg)
  }
}

lapply(packages, library, character.only = TRUE)
```

This block of code will conditionally install (if not already present) and load all packages required for the pipeline. Version control of these packages can be found in the linked GitHub repository.

### 3. Setting Work Directory

`setwd(working_directory)` is included in the original script but cannot function in an R Markdown file. It sets the working directory as the initial `working_directory` path.

### 4. Creating Directory Structure

This section of code looks at whether the `outputs` and subsequent `total_lipids` and `error_files` directories are present in the working directory. If they are not, it will create them. These will then serve as storage locations for subsequent outputs.

```{r, results='hide', message=FALSE, warning=FALSE}
if(!dir.exists("outputs")){
  cat("'Outputs' directory created")
  dir.create("outputs")
} else {
  cat("'Outputs' directory already exists")
}

if(!dir.exists("outputs/total_lipids")){
  cat("'total_lipids' directory created")
  dir.create("outputs/total_lipids", recursive = TRUE)
} else {
  cat("'total_lipids' directory already exists")
}

if(!dir.exists("outputs/error_files")){
  cat("'error_files' directory created")
  dir.create("outputs/error_files", recursive = TRUE)
} else {
  cat("'error_files' directory already exists")
}
```


### 5. Initial Data Tidying

This section of code uses the `raw_data` input previously provided to, firstly, look for any duplicated columns. A file containing the names of any duplicated columns will be provided in the `error_files` directory. These are columns where each row's value is identical to that of another column. This could be a mistake or could be a genuine part of the data. Therefore, it is imperative that you check this document and decide on this independently. If you believe that there is a mistake and a column needs to be removed, please return to your original excel spreadsheet, make any changes required, resave it and run the pipeline again from the beginning. 

Secondly, the pipeline uses patterns to recognise lipid data vs metadata and separate them. R Studio cannot use the `TG(50:0)` lipid naming structure for column names. Therefore, it will transform them to `TG_.50.0.` format. This means that all lipid columns should end with `.` and the pipeline will recognise them as lipid data. Anything not ending with `.` will be classified as metadata and saved as such. Therefore, adherance to the naming guidelines above is very important. 

```{r, results='hide', message=FALSE, warning=FALSE}
raw_data <- read.csv(raw_data_file_name, header = T)

raw_data_lipids <- raw_data
duplicated_columns <- duplicated(as.list(raw_data_lipids))
any(duplicated_columns)
duplicated_column_names <- names(raw_data_lipids)[duplicated_columns]
print(duplicated_column_names)
duplicated_column_names <- data.frame(duplicated_columns = duplicated_column_names)
write.csv(duplicated_column_names, "outputs/error_files/duplicated_columns.csv", row.names = FALSE)

metadata <- raw_data[ , !(grepl("\\.$", names(raw_data)) | names(raw_data) == "Cholesterol")]
groups <- metadata[,"Group"]
raw_data_lipids <- raw_data[ , grepl("\\.$", names(raw_data)) | names(raw_data) == "Cholesterol"]
str(raw_data_lipids)
raw_data_lipids[] <- lapply(raw_data_lipids, function(x) as.numeric(as.character(x)))
str(raw_data_lipids)
sum(is.na(raw_data_lipids[,ncol(raw_data_lipids)]))
```


### 6. Lipids Tested Manipulation

This section of code will use the `lipids_tested` file previously specified and structure it appropriately for further analysis. 

```{r, results='hide', message=FALSE, warning=FALSE}
lipids_tested <- read.csv(lipids_tested_file_name, header = T)
lipids_tested <- pivot_longer(lipids_tested,
    cols = everything(),
    names_to = "family",
    values_to = "lipid"
  )
lipids_tested <- lipids_tested[order(lipids_tested$family), ]
lipids_tested <- lipids_tested[!(is.na(lipids_tested$lipid) | lipids_tested$lipid == ""), ]
lipids_tested$lipid <- make.names(lipids_tested$lipid)
```


### 7. Checking For Mismatched Columns

This code will match all lipid columns from raw data to their respective family. Any columns not successfully matched to a family will be listed in the `error_files/unmatched_columns.csv` file and should be checked and data corrcted before proceeding. Any lipids listed in this file (not matched to a family) will be excluded from further analysis. 

```{r, results='hide', message=FALSE, warning=FALSE}
raw_data_columns <- colnames(raw_data_lipids[ncol(raw_data_lipids)])
lipids <- lipids_tested$lipid
unmatched_cols <- setdiff(raw_data_columns, lipids)
number_unmatched <- length(unmatched_cols)
unmatched_cols <- data.frame(Unmatched_columns = unmatched_cols)
write.csv(unmatched_cols, "outputs/error_files/unmatched_columns.csv", row.names = FALSE) # this should be empty because the mismatched columns now end up in the metadata object
```


### 8. Subset Data By Lipid Family

Here, naming is standardised and the `raw_data` is split by family into respctive data frames for further analysis. it then creates a list called `raw_data_names`. This list contains only the names of all separated family raw data frames for use in subsequent looping. The section between the two `## OPTIONAL ##` flags at the bottom shows users how to rename variables if there are issue with the length of the names when saving objects. If not in use, this section should be removed. 

```{r, results='hide', message=FALSE, warning=FALSE}
sanitize_name <- function(x) {
  x <- gsub("[^A-Za-z0-9]+", "_", x)  # replace non-alphanumeric with underscore
  x <- gsub("_+", "_", x)             # collapse multiple underscores
  x <- gsub("^_|_$", "", x)           # trim leading/trailing underscores
  x
}

lipids_tested$Family_clean <- sanitize_name(lipids_tested$family)
lipid_families <- split(lipids_tested$lipid, lipids_tested$Family_clean)
raw_data_by_family <- list()

for(family in names(lipid_families)) {
  cols <- lipid_families[[family]]
  cols <- intersect(cols, colnames(raw_data_lipids))
  raw_data_by_family[[family]] <- raw_data[, cols, drop = FALSE]
}

for(family in names(raw_data_by_family)) {
  assign(paste0("raw_data_", family), raw_data_by_family[[family]])
}

all_raw_data <- ls(pattern = "^raw_data_")

for (name in all_raw_data) {
  df <- get(name)
  if (is.data.frame(df) && ncol(df) == 0) {
    message("Removing empty data frame: ", name)
    rm(list = name, envir = .GlobalEnv)
    all_raw_data <- setdiff(all_raw_data, name)  
  }
}

raw_data_names <- Filter(function(x) {
  obj <- get(x)
  
  if (!is.data.frame(obj)) {
    message("Excluded for not being a data frame: ", x)
    return(FALSE)
  }
  
  if (!all(sapply(obj, is.numeric))) {
    message("Excluded for non-numeric columns: ", x)
    return(FALSE)
  }

  TRUE
}, all_raw_data)

## OPTIONAL ##

#1
raw_data_CPEs <- raw_data_Ceramide_phospho_ethanolamines
rm(raw_data_Ceramide_phospho_ethanolamines)
#3
raw_data_LPEs <- raw_data_Lysophosphatidy_ethanolamines
rm(raw_data_Lysophosphatidy_ethanolamines)

raw_data_names <- c(raw_data_names, c("raw_data_CPEs", "raw_data_LPEs"))
raw_data_names <- raw_data_names[!raw_data_names %in% c("raw_data_Ceramide_phospho_ethanolamines", "raw_data_Lysophosphatidy_ethanolamines")]

## OPTIONAL ##

raw_data_names <- raw_data_names[raw_data_names != "raw_data_lipids"]
raw_data_names
```


### 9. Creating Folders For All Lipid Families and Categories

Finally, this section assigns each family to its correct lipid category and makes directories for all in an `outputs` folder called `lipid_categories`. These files will be used for all relative outputs going forwards. 

Currently, the categorisation of lipid families is a manual job. However, this is likely to soon be updated. 

A template is created and output to the working directory called `complete_lipid_categories.csv`. This csv file gives a list of all the families from your data that categories must be assigned to, using the LIPID MAPS database. This must be done in a case and character sensitive fashion with no spaces i.e. all families included in glycerolipids should have the exact category name `glycerolipids` and underscores replacing spaces. An example of the layout of this file can be seen below. Do not change the output file at all other than adding respective category names. Then proceed with the script.

| Family                          | Category                          |
|:--------------------------------|:----------------------------------|
| PC                              | Glycerophospholipids              |
| PE                              | Glycerophospholipids              |
| TG                              | Glycerolipids                     |
| DG                              | Glycerolipids                     |
| Cer                             | Sphingolipids                     |
| SM                              | Sphingolipids                     |
| CE                              | Sterol_Lipids                     |


```{r, results='hide', message=FALSE, warning=FALSE}
write.csv(
  data.frame(Family = names(lipid_families)),
  "lipid_categories_1.csv",
  row.names = FALSE
) ## THIS NEEDS TO BE FILLED IN BY THE CLIENT AND SAVED AS 'complete_lipid_categories.csv'

category_mapping <- read.csv("complete_lipid_categories.csv", stringsAsFactors = FALSE)

category_mapping$Family_clean   <- sanitize_name(category_mapping$Family)
category_mapping$Category_clean <- sanitize_name(category_mapping$Category)

top_level_dir <- file.path("outputs", "lipid_categories")

if (!dir.exists(top_level_dir)) {
  dir.create(top_level_dir, recursive = TRUE, showWarnings = FALSE)
}

count <- 1

for (name in raw_data_names) {
  lipid_family <- make.names(sub("^raw_data_", "", name))
  category <- category_mapping$Category_clean[category_mapping$Family_clean == lipid_family][1]
  
  if (is.na(category) || length(category) == 0) {
    message("No category found for family: ", lipid_family)
    next
  }
  
  folder_path <- file.path(top_level_dir, category, lipid_family)
  
  if (!dir.exists(folder_path)) {
    dir.create(folder_path, recursive = TRUE, showWarnings = FALSE)
    message(count, ". Folder created: ", folder_path)
    count <- count + 1
  }
}
```

